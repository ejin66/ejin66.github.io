---
layout: post
title: TCP、IP与MAC
tags: [Network]
---

## HTTP协议



## Websocket协议



## TCP协议



## UDP协议



## IP协议

IP协议工作在网络层，上层数据帧发送前会经过网络层，此时会在数据帧前添加IP消息头。关于IP协议，分享一篇写得很详细、全面的好文：[网络层协议--IP协议](https://zhuanlan.zhihu.com/p/572053966).

作为学习笔记，我重复下IP协议的定义：

![ip协议]({{site.baseurl}}/assets/img/pexels/ip协议.png)

![ip协议](/Users/jintian/Documents/ip协议.png)

- 4位版本号（version）：指定IP协议的版本（IPv4/IPv6）。

  对于IPv4来说，就是4。

- 4位首部长度（header length）：表示IP报头的长度，以4字节为单位。

  若IP首部没有可选项，那首部的大小为20byte. 由于单位是4byte, 那这里的长度为5（0101）。

  同时，可以计算下IP头以及可选项的最大字节数，首部最大15，即15 * 4 = 60 byte, 可选项最大60 - 20 = 40 byte.

- 8位服务类型（Type Of Service）：3位优先权字段（已经弃用），4位TOS字段，和1位保留字段（必须置为0）。

  4位TOS分别表示：最小延时，最大吞吐量，最高可靠性，最小成本。这四者相互冲突，只能选择一个。比如对于ssh/telnet这样的应用程序，最小延时比较重要，而对于ftp这样的程序，最大吞吐量比较重要。

- 16位总长度（total length）：IP报文（IP报头+有效载荷）的总长度，用于将各个IP报文进行分离。

  长度单位是byte，可以计算下单帧理论上的最大有效载荷，65535 - 20 = 65515 byte。当然这仅是理论值，实际上远远达不到，具体原因看下面的分片部分。

- 16位标识（id）：唯一的标识主机发送的报文，如果数据在IP层进行了分片，那么每一个分片对应的id都是相同的。

- 3位标志字段：第一位保留，表示暂时没有规定该字段的意义。第二位表示禁止分片，表示如果报文长度超过MTU，IP模块就会丢弃该报文。第三位表示“更多分片”，如果报文没有进行分片，则该字段设置为0，如果报文进行了分片，则除了最后一个分片报文设置为0以外，其余分片报文均设置为1。

  这里涉及到IP分片的问题，根本原因是数据链路层对单帧数据的大小有限制。在数据链路层，MAC帧规定了单帧数据的最大值: 最大传输单元，MTU（Maximum Transmission Unit）。一般MTU的值是1500byte，超过该值的数据会在这里被丢弃，因此在网络层会对大Size的数据进行分片处理，拆成多帧数据给到数据链路层。最后多片数据会在客户端的IP层进行组装，完整后给到上层。

- 13位片偏移（framegament offset）：分片相对于原始数据开始处的偏移，表示当前分片在原数据中的偏移位置，实际偏移的字节数是 ${offset} * 8 byte。因此除了最后一个报文之外，其他报文的长度必须是8的整数倍，否则报文就不连续了。
- 8位生存时间（Time To Live，TTL）：数据报到达目的地的最大报文跳数，一般是64，每经过一个路由，TTL -= 1，一直减到0还没到达，那么就丢弃了，这个字段主要是用来防止出现路由循环。
- 8位协议：表示上层协议的类型。
- 16位首部检验和：使用CRC进行校验，来鉴别数据报的首部是否损坏，但不检验数据部分。
- 32位源IP地址和32位目的IP地址：表示发送端和接收端所对应的IP地址。
- 可选项：不定长，最多40字节。





## ARP协议

arp -a arp缓存表

Netstat -r ip路由表

Tracert ip/域名



## IP路由

